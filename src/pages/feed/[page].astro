---
import { getCollection } from "astro:content";
import Base from "@/layouts/Base.astro";
import Feed from "@/components/Feed.astro";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const perPage = 5;
    const totalPages = Math.ceil(allPosts.length / perPage);
    return Array.from({ length: totalPages }, (_, i) => ({
        params: { page: String(i + 1) },
    }));
}

const { page } = Astro.params;
const pageNumber = Number(page) || 1;
const perPage = 5;

const allPosts = await getCollection("blog");
allPosts.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

const currentPosts = allPosts.slice(
    (pageNumber - 1) * perPage,
    pageNumber * perPage,
);

const processedPosts = currentPosts.map((post) => {
    const len = post.body.split(/\s+/).length;
    const time = Math.floor(len / 130);
    return { ...post, wordCount: len, readingTime: time > 0 ? time : 1 };
});
---

<Base title={`Feed Page ${pageNumber}`}>
    <Feed posts={processedPosts} />
</Base>

<style is:inline>
    .wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .wrapper .post {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .wrapper .post .body {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 12rem;
        padding: 0.5rem;
    }

    @media (min-width: 64rem) {
        .wrapper .post .body h1::before {
            content: ".";
            position: absolute;
            padding: 0;
            left: -1rem;
            top: 0.7rem;
            font-size: 1rem;
            font-weight: 100;
            border-radius: 1rem;
            background-color: var(--primary-color);
            color: var(--primary-color);
        }

        .wrapper .post .body {
            padding: 1rem 1.75rem;
        }
    }

    .heading {
        position: relative;
    }

    .wrapper .post .cover {
        position: relative;
        right: 26.8rem;
    }

    .wrapper .post img {
        position: absolute;
        top: -0.75rem;
        left: 0;
        height: 15.5rem;
        border-radius: var(--border-rounded);
        border-top-left-radius: 0;
        clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 12% 100%);
        filter: grayscale(1);
        transition: filter 0.2s;
    }

    .wrapper .post img:hover {
        filter: grayscale(0);
    }

    @media (max-width: 56rem) {
        .wrapper .post {
            flex-direction: column;
            width: 80vw;
            @media (max-width: 32rem) {
                width: auto;
            }
            margin-inline: auto;
            border-radius: var(--border-rounded);
            overflow: hidden;
        }

        .wrapper .post .body {
            height: auto;
        }

        .wrapper .post img {
            position: relative;
            top: -0.75rem;
            left: -0.75rem;
            width: calc(100% + 1.5rem);
            height: auto;
            clip-path: none;
            filter: none;
        }
    }
</style>
