---
import Base from "@/layouts/Base.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import PostList from "@/components/PostList.astro";

const { tag } = Astro.params;
type BlogEntry = CollectionEntry<"blog">;

const allPosts: BlogEntry[] = await getCollection("blog");
const published = allPosts.filter((p) => !p.data.draft);

const posts = tag
  ? published.filter((p) => p.data.tags?.some((t) => t.toLowerCase() === tag.toLowerCase()))
  : published;

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const publishedPosts = allPosts.filter((p) => !p.data.draft);
  const tags = Array.from(new Set(publishedPosts.flatMap((p) => p.data.tags ?? [])));

  return tags.map((t) => ({ params: { tag: t } }));
}
---

<Base>
  <div class="card">
    <h1><code>{tag}</code></h1>
    <PostList posts={posts} />
  </div>
</Base>
